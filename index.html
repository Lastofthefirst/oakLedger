<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3E2723">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Oak Ledger - Invoice Generator</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“„</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind config for oak palette
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        oak: {
                            50: '#F5E6D3',
                            100: '#EDD9C3',
                            200: '#D4A574',
                            300: '#C69963',
                            400: '#A67C52',
                            500: '#8B6F47',
                            600: '#6D5639',
                            700: '#4E3D2B',
                            800: '#3E2723',
                            900: '#2C1810',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Prevent pull-to-refresh on PWA */
        body {
            overscroll-behavior-y: contain;
        }

        html {
            overscroll-behavior: none;
        }

        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Hide default file input */
        input[type="file"] {
            display: none;
        }

        /* Letterhead preview */
        .letterhead-preview {
            max-height: 120px;
            object-fit: contain;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .letterhead-preview:hover {
            opacity: 0.8;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #F5E6D3;
        }

        ::-webkit-scrollbar-thumb {
            background: #8B6F47;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6D5639;
        }

        /* Smooth transitions */
        * {
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-duration: 200ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        input, textarea, select {
            transition-property: all;
        }

        /* Input clear button styling */
        .input-wrapper {
            position: relative;
        }

        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .input-wrapper:hover .clear-btn,
        .input-wrapper:focus-within .clear-btn {
            opacity: 0.5;
            pointer-events: auto;
        }

        .clear-btn:hover {
            opacity: 1 !important;
        }

        /* For textarea wrappers */
        .textarea-wrapper .clear-btn {
            top: 12px;
            transform: none;
        }

        /* Toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #8B6F47;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #8B6F47;
        }

        /* Import button selected state */
        .import-button-selected {
            background-color: #8B6F47 !important;
            color: white !important;
        }
    </style>
</head>
<body class="h-full bg-oak-50 text-oak-900">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-oak-800 border-b border-oak-700">
            <div class="mx-auto max-w-4xl px-4 py-6 sm:px-6 lg:px-8">
                <div class="flex flex-col items-center gap-4">
                    <!-- Letterhead Upload Area -->
                    <div id="letterheadContainer" class="w-full flex justify-center">
                        <div class="bg-white rounded-lg px-8 py-6">
                            <div id="letterheadUploadArea" class="border-2 border-dashed border-oak-200 rounded-lg px-6 py-4 text-center hover:border-oak-400 cursor-pointer transition-colors">
                                <svg class="mx-auto h-12 w-12 text-oak-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <p class="mt-2 text-sm text-oak-700">Click to upload letterhead</p>
                                <p class="text-xs text-oak-500">PNG, JPG, SVG up to 2MB</p>
                                <p class="text-xs text-oak-500 mt-1">Transparent or white background works best</p>
                            </div>
                            <img id="letterheadPreview" class="letterhead-preview hidden mt-2 mx-auto" alt="Letterhead">
                        </div>
                    </div>
                    <input type="file" id="letterheadInput" accept="image/*">

                    <div class="text-center">
                        <h1 class="text-3xl font-bold tracking-tight text-oak-50 sm:text-4xl">Oak Ledger</h1>
                        <p class="mt-2 text-sm text-oak-200">Quick and easy invoices</p>
                    </div>
                </div>
            </div>
        </header>

        <main class="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
            <!-- Import Mode Button -->
            <div class="mb-6 flex items-center justify-end gap-3">
                <button id="importModeButton" type="button"
                    class="inline-flex items-center justify-center rounded-lg bg-oak-200 px-4 py-2 text-sm font-medium text-oak-700 hover:bg-oak-300 focus:outline-none focus:ring-2 focus:ring-oak-500 focus:ring-offset-2 transition-colors">
                    Import
                </button>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="hidden mb-6 rounded-lg bg-green-100 border border-green-400 p-4 fade-in">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-green-800">Invoice created successfully! Check your downloads.</p>
                    </div>
                </div>
            </div>

            <!-- Import Mode Section -->
            <div id="importSection" class="hidden mb-6 space-y-4">
                <!-- LLM Prompt Helper -->
                <div class="rounded-lg bg-white border border-oak-200 shadow-lg fade-in">
                    <div class="border-b border-oak-200 px-6 py-4">
                        <h2 class="text-lg font-semibold text-oak-900">LLM Assistant</h2>
                        <p class="mt-1 text-sm text-oak-600">Paste invoice details below, then copy the prompt to use with an LLM</p>
                    </div>
                    <div class="px-6 py-5 space-y-4">
                        <div>
                            <label for="llmInput" class="block text-sm font-medium text-oak-700 mb-2">Invoice Details (Plain Text)</label>
                            <textarea id="llmInput" rows="4" placeholder="Paste or type invoice details here (optional)..."
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm"></textarea>
                        </div>
                        <button id="copyPromptBtn" type="button"
                            class="w-full inline-flex items-center justify-center rounded-lg bg-oak-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-oak-700 focus:outline-none focus:ring-2 focus:ring-oak-500 focus:ring-offset-2 shadow">
                            <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            Copy LLM Prompt
                        </button>
                        <p id="copiedMessage" class="hidden text-sm text-green-600 text-center">âœ“ Copied to clipboard!</p>
                    </div>
                </div>

                <!-- JSON Import -->
                <div class="rounded-lg bg-white border border-oak-200 shadow-lg fade-in">
                    <div class="border-b border-oak-200 px-6 py-4">
                        <h2 class="text-lg font-semibold text-oak-900">Import Invoice Data</h2>
                        <p class="mt-1 text-sm text-oak-600">Paste JSON data structure to populate fields</p>
                    </div>
                    <div class="px-6 py-5 space-y-4">
                        <div>
                            <label for="importJson" class="block text-sm font-medium text-oak-700 mb-2">JSON Data</label>
                            <textarea id="importJson" rows="6" placeholder='{"clientName": "Acme Corp", "fee": 500, ...}'
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm font-mono"></textarea>
                        </div>
                        <button id="importBtn" type="button"
                            class="w-full inline-flex items-center justify-center rounded-lg bg-oak-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-oak-700 focus:outline-none focus:ring-2 focus:ring-oak-500 focus:ring-offset-2 shadow">
                            <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Import & Generate PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Normal Mode Section -->
            <div id="normalSection">
                <!-- Business Details Card -->
                <div class="mb-6 rounded-lg bg-white border border-oak-200 shadow-lg fade-in">
                    <div class="border-b border-oak-200 px-6 py-4 cursor-pointer" id="businessHeader">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-lg font-semibold text-oak-900">Your Business Details</h2>
                                <p class="mt-1 text-sm text-oak-600">Saved information for your invoices</p>
                            </div>
                            <svg id="businessChevron" class="h-5 w-5 text-oak-600 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div id="businessContent" class="px-6 py-5 space-y-4">
                        <!-- Business Profile Tabs -->
                        <div class="mb-4">
                            <div class="flex flex-wrap justify-between items-end gap-2 mb-2">
                                <div id="businessProfileTabs" class="flex flex-wrap gap-1"></div>
                                <button id="addBusinessProfileBtn" type="button"
                                    class="px-3 py-2 text-sm font-medium rounded-lg bg-oak-100 text-oak-600 hover:bg-oak-200 flex items-center justify-center"
                                    title="Add new business profile">+</button>
                            </div>
                            <!-- Tab bottom border to connect visually with content -->
                            <div class="h-1 bg-oak-200 rounded-t-md"></div>
                        </div>
                        <!-- Business Profile Delete Button -->
                        <div class="flex justify-end">
                            <button id="deleteBusinessProfileBtn" type="button"
                                class="px-3 py-1 text-sm font-medium rounded-lg text-red-600 hover:bg-red-50 hidden"
                                title="Remove this business profile">Remove</button>
                        </div>

                        <div>
                            <label for="businessName" class="block text-sm font-medium text-oak-700 mb-2">Business Name</label>
                            <input type="text" id="businessName" placeholder="Your Business Name"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm">
                        </div>
                        <div>
                            <label for="yourName" class="block text-sm font-medium text-oak-700 mb-2">Your Name</label>
                            <input type="text" id="yourName" placeholder="Your Full Name"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm">
                        </div>
                        <div>
                            <label for="phoneNumber" class="block text-sm font-medium text-oak-700 mb-2">Phone Number</label>
                            <input type="tel" id="phoneNumber" placeholder="(123) 456-7890"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm">
                        </div>
                        <div>
                            <label for="businessAddress" class="block text-sm font-medium text-oak-700 mb-2">Business Address</label>
                            <textarea id="businessAddress" rows="3" placeholder="123 Your Street&#10;City, State ZIP"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Invoice Details Card -->
                <div class="mb-6 rounded-lg bg-white border border-oak-200 shadow-lg fade-in">
                    <div class="border-b border-oak-200 px-6 py-4">
                        <h2 class="text-lg font-semibold text-oak-900">Invoice Details</h2>
                        <p class="mt-1 text-sm text-oak-600">Fill in the details for this invoice</p>
                        <p class="mt-1 text-xs text-oak-500">All details are optional</p>
                    </div>
                    <div class="px-6 py-5 space-y-4">
                        <div>
                            <label for="invoiceNumber" class="block text-sm font-medium text-oak-700 mb-2">
                                Invoice Number <span class="text-oak-500">(Automatic)</span>
                            </label>
                            <input type="text" id="invoiceNumber" placeholder="INV-0001"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm font-mono">
                            <p class="mt-1 text-xs text-oak-500">Leave blank for auto-increment, or enter a number (e.g., 45 becomes INV-045)</p>
                        </div>

                        <div class="input-wrapper">
                            <label for="clientName" class="block text-sm font-medium text-oak-700 mb-2">Client Name</label>
                            <input type="text" id="clientName" placeholder="Client's Name or Company"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 pr-10 text-sm">
                            <button type="button" class="clear-btn text-oak-400 hover:text-oak-600" onclick="document.getElementById('clientName').value = ''; updatePreview();">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <div class="textarea-wrapper input-wrapper">
                            <label for="clientAddress" class="block text-sm font-medium text-oak-700 mb-2">Client Address</label>
                            <textarea id="clientAddress" rows="3" placeholder="123 Main Street&#10;Anytown, USA 12345"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 pr-10 text-sm"></textarea>
                            <button type="button" class="clear-btn text-oak-400 hover:text-oak-600" onclick="document.getElementById('clientAddress').value = ''; updatePreview();">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <div>
                            <div>
                                <label for="invoiceDate" class="block text-sm font-medium text-oak-700 mb-2">Invoice Date</label>
                                <input type="date" id="invoiceDate"
                                    class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-oak-700 mb-2">Work Period</label>
                            <div class="bg-oak-100/30 rounded-lg p-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="workStartDate" class="block text-sm font-medium text-oak-700 mb-2">Start</label>
                                        <input type="date" id="workStartDate"
                                            class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm">
                                    </div>
                                    <div>
                                        <label for="workEndDate" class="block text-sm font-medium text-oak-700 mb-2">End</label>
                                        <input type="date" id="workEndDate"
                                            class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="services" class="block text-sm font-medium text-oak-700 mb-2">Services Provided</label>
                            <textarea id="services" rows="4" placeholder="e.g., Web Design Services&#10;- Homepage Mockup&#10;- Contact Form Integration"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm"></textarea>
                        </div>

                        <div>
                            <label for="fee" class="block text-sm font-medium text-oak-700 mb-2">Fee ($)</label>
                            <input type="number" id="fee" placeholder="0.00" step="0.01"
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm">
                        </div>

                        <div>
                            <label for="notes" class="block text-sm font-medium text-oak-700 mb-2">Notes</label>
                            <textarea id="notes" rows="3" placeholder="e.g., Payment due within 30 days."
                                class="block w-full rounded-lg border-oak-200 bg-oak-50/30 text-oak-900 placeholder-oak-400 focus:border-oak-500 focus:ring-oak-500 px-4 py-2.5 text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 mb-8">
                    <div class="flex gap-3 flex-1">
                        <button id="previewBtn" type="button"
                            class="flex-1 inline-flex items-center justify-center rounded-lg bg-oak-200 px-4 py-2.5 text-sm font-semibold text-oak-900 hover:bg-oak-300 focus:outline-none focus:ring-2 focus:ring-oak-500 focus:ring-offset-2 shadow">
                            <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            Preview
                        </button>
                        <button id="fillDemoBtn" type="button" title="Fill with witty demo data"
                            class="inline-flex items-center justify-center rounded-lg bg-oak-100 px-3 py-2.5 text-sm text-oak-600 hover:bg-oak-200 focus:outline-none focus:ring-2 focus:ring-oak-400">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                        </button>
                    </div>
                    <button id="generateBtn" type="button"
                        class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-lg bg-oak-600 px-6 py-2.5 text-sm font-semibold text-white hover:bg-oak-700 focus:outline-none focus:ring-2 focus:ring-oak-500 focus:ring-offset-2 shadow-lg">
                        <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Create PDF
                    </button>
                </div>
            </div>

                <!-- Preview Card -->
                <div id="invoicePreview" class="hidden rounded-lg bg-white border border-oak-200 shadow-xl overflow-hidden fade-in">
                    <div class="bg-gradient-to-r from-oak-600 to-oak-700 px-6 py-4">
                        <h3 class="text-lg font-semibold text-white">Invoice Preview</h3>
                    </div>
                    <div class="px-6 py-8 text-oak-900">
                        <!-- Letterhead in preview -->
                        <div id="previewLetterhead" class="mb-6 text-center hidden">
                            <img id="previewLetterheadImg" class="mx-auto max-h-24 object-contain" alt="Letterhead">
                        </div>

                        <div class="flex justify-between items-start mb-8">
                            <div class="text-3xl font-bold text-oak-900">INVOICE</div>
                            <div id="invoiceNumberPreview" class="text-lg font-semibold text-oak-600">#INV-0001</div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div id="previewFromSection" class="hidden">
                                <div class="text-xs font-semibold text-oak-500 uppercase tracking-wide mb-2">From</div>
                                <div id="previewBusinessName" class="font-medium text-oak-900"></div>
                                <div id="previewYourName" class="text-oak-700"></div>
                                <div id="previewPhone" class="text-oak-700"></div>
                                <div id="previewBusinessAddress" class="text-oak-700 whitespace-pre-line mt-1"></div>
                            </div>

                            <div id="previewToSection" class="hidden">
                                <div class="text-xs font-semibold text-oak-500 uppercase tracking-wide mb-2">Bill To</div>
                                <div id="previewClientName" class="font-medium text-oak-900"></div>
                                <div id="previewClientAddress" class="text-oak-700 whitespace-pre-line"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div id="previewDateSection" class="hidden">
                                <div class="text-xs font-semibold text-oak-500 uppercase tracking-wide mb-2">Invoice Date</div>
                                <div id="previewInvoiceDate" class="text-oak-900"></div>
                            </div>

                            <div id="previewServiceDateSection" class="hidden">
                                <div class="text-xs font-semibold text-oak-500 uppercase tracking-wide mb-2">Service Date</div>
                                <div id="previewServiceDate" class="text-oak-900"></div>
                            </div>
                        </div>

                        <div id="previewServicesSection" class="mb-8 hidden">
                            <div class="text-xs font-semibold text-oak-500 uppercase tracking-wide mb-2">Description</div>
                            <div id="previewServices" class="text-oak-900 whitespace-pre-line"></div>
                        </div>

                        <div id="previewFeeSection" class="mb-8 hidden border-t-2 border-oak-300 pt-6">
                            <div class="flex justify-between items-center">
                                <div class="text-lg font-semibold text-oak-900">Total Amount Due</div>
                                <div id="previewFee" class="text-3xl font-bold text-oak-600"></div>
                            </div>
                        </div>

                        <div id="previewNotesSection" class="hidden border-t-2 border-oak-200 pt-6">
                            <div class="text-xs font-semibold text-oak-500 uppercase tracking-wide mb-2">Notes</div>
                            <div id="previewNotes" class="text-oak-700 whitespace-pre-line"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-12 border-t border-oak-300 py-6">
            <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
                <p class="text-center text-sm text-oak-600">
                    Oak Ledger â€¢ Data stored locally
                </p>
            </div>
        </footer>
    </div>

    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered', reg))
                .catch(err => console.log('Service Worker registration failed', err));
        }

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // Global state

        // DOM Elements
        const importModeButton = document.getElementById('importModeButton');
        const importSection = document.getElementById('importSection');
        const normalSection = document.getElementById('normalSection');
        const businessHeader = document.getElementById('businessHeader');
        const businessContent = document.getElementById('businessContent');
        const businessChevron = document.getElementById('businessChevron');

        const businessNameInput = document.getElementById('businessName');
        const yourNameInput = document.getElementById('yourName');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const businessAddressInput = document.getElementById('businessAddress');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const clientNameInput = document.getElementById('clientName');
        const clientAddressInput = document.getElementById('clientAddress');
        const invoiceDateInput = document.getElementById('invoiceDate');
        const workStartDateInput = document.getElementById('workStartDate');
        const workEndDateInput = document.getElementById('workEndDate');
        const servicesInput = document.getElementById('services');
        const feeInput = document.getElementById('fee');
        const notesInput = document.getElementById('notes');

        const previewBtn = document.getElementById('previewBtn');
        const generateBtn = document.getElementById('generateBtn');
        const fillDemoBtn = document.getElementById('fillDemoBtn');
        const invoicePreview = document.getElementById('invoicePreview');
        const successMessage = document.getElementById('successMessage');

        const letterheadInput = document.getElementById('letterheadInput');
        const letterheadUploadArea = document.getElementById('letterheadUploadArea');
        const letterheadPreview = document.getElementById('letterheadPreview');

        const llmInput = document.getElementById('llmInput');
        const copyPromptBtn = document.getElementById('copyPromptBtn');
        const copiedMessage = document.getElementById('copiedMessage');
        const importJson = document.getElementById('importJson');
        const importBtn = document.getElementById('importBtn');

        // Import Mode Button
        let isImportMode = false;
        importModeButton.addEventListener('click', function() {
            isImportMode = !isImportMode;

            if (isImportMode) {
                // Switch to import mode
                importSection.classList.remove('hidden');
                normalSection.classList.add('hidden');
                importModeButton.classList.add('import-button-selected');
            } else {
                // Switch back to normal mode
                importSection.classList.add('hidden');
                normalSection.classList.remove('hidden');
                importModeButton.classList.remove('import-button-selected');
            }
        });

        // Collapsible Business Section
        let businessCollapsed = false;
        businessHeader.addEventListener('click', function() {
            businessCollapsed = !businessCollapsed;
            if (businessCollapsed) {
                businessContent.classList.add('hidden');
                businessChevron.style.transform = 'rotate(-90deg)';
            } else {
                businessContent.classList.remove('hidden');
                businessChevron.style.transform = 'rotate(0deg)';
            }
        });

        function checkAutoCollapse() {
            const profile = businessProfiles[currentProfileIndex];
            if (profile && (profile.businessName || profile.yourName)) {
                businessCollapsed = true;
                businessContent.classList.add('hidden');
                businessChevron.style.transform = 'rotate(-90deg)';
            }
        }

        // --- Business Profile Management (Refactored) ---

        let businessProfiles = [];
        let currentProfileIndex = 0;

        function createEmptyProfile() {
            return {
                businessName: '',
                yourName: '',
                phoneNumber: '',
                businessAddress: '',
                lastInvoiceNumber: 0
            };
        }

        function persistProfiles() {
            localStorage.setItem('businessProfiles', JSON.stringify(businessProfiles));
        }

        function loadProfiles() {
            const savedProfiles = localStorage.getItem('businessProfiles');
            if (savedProfiles && JSON.parse(savedProfiles).length > 0) {
                businessProfiles = JSON.parse(savedProfiles);
            } else {
                businessProfiles = [createEmptyProfile()];
            }
            currentProfileIndex = Math.min(Math.max(0, parseInt(localStorage.getItem('currentProfileIndex') || '0')), businessProfiles.length - 1);
        }

        function updateUiForProfileSwitch() {
            loadProfileData(currentProfileIndex);
            renderBusinessProfileTabs();
            updateButtonVisibility();
            updatePreview();
        }

        function saveCurrentProfileData() {
            const profile = businessProfiles[currentProfileIndex];
            if (!profile) return;

            profile.businessName = businessNameInput.value;
            profile.yourName = yourNameInput.value;
            profile.phoneNumber = phoneNumberInput.value;
            profile.businessAddress = businessAddressInput.value;
            
            persistProfiles();
        }

        function loadProfileData(index) {
            const profile = businessProfiles[index];
            if (!profile) return;

            businessNameInput.value = profile.businessName;
            yourNameInput.value = profile.yourName;
            phoneNumberInput.value = profile.phoneNumber;
            businessAddressInput.value = profile.businessAddress;

            const savedLetterhead = localStorage.getItem(`businessLetterhead_${index}`);
            if (savedLetterhead) {
                letterheadPreview.src = savedLetterhead;
                letterheadPreview.classList.remove('hidden');
                letterheadUploadArea.classList.add('hidden');
            } else {
                letterheadPreview.classList.add('hidden');
                letterheadUploadArea.classList.remove('hidden');
            }

            const lastInvoiceNumber = profile.lastInvoiceNumber || 0;
            invoiceNumberInput.placeholder = `INV-${(lastInvoiceNumber + 1).toString().padStart(3, '0')}`;
        }
        
        function renderBusinessProfileTabs() {
            const tabsContainer = document.getElementById('businessProfileTabs');
            tabsContainer.innerHTML = '';

            businessProfiles.forEach((profile, index) => {
                const tabButton = document.createElement('button');
                tabButton.type = 'button';
                tabButton.textContent = profile.businessName || `Business ${index + 1}`;
                tabButton.dataset.profileIndex = index;
                
                if (index === currentProfileIndex) {
                    tabButton.className = 'px-3 py-3 text-sm font-medium bg-white text-oak-900 border-t border-l border-r border-oak-400 rounded-t-lg shadow-sm z-10 -mb-1';
                } else {
                    tabButton.className = 'px-3 py-2 text-sm font-medium bg-oak-200 text-oak-700 hover:bg-oak-300 border border-oak-300 rounded-t-md';
                }

                tabButton.addEventListener('click', () => {
                    if (currentProfileIndex !== index) {
                        switchToProfile(index);
                    }
                });

                tabsContainer.appendChild(tabButton);
            });
        }

        function switchToProfile(index) {
            saveCurrentProfileData();
            currentProfileIndex = index;
            localStorage.setItem('currentProfileIndex', currentProfileIndex);
            updateUiForProfileSwitch();
        }

        function addNewBusinessProfile() {
            if (businessProfiles.length < 4) {
                saveCurrentProfileData();
                businessProfiles.push(createEmptyProfile());
                persistProfiles();
                switchToProfile(businessProfiles.length - 1);
            }
        }

        function removeBusinessProfile() {
            if (businessProfiles.length > 1) {
                if (confirm('Are you sure you want to remove this business profile?')) {
                    // Also remove associated separate data
                    localStorage.removeItem(`businessLetterhead_${currentProfileIndex}`);
                    
                    businessProfiles.splice(currentProfileIndex, 1);
                    persistProfiles();

                    // Adjust current index if we removed the last profile in the list
                    const newIndex = Math.min(currentProfileIndex, businessProfiles.length - 1);
                    
                    // No need to save here, just switch
                    currentProfileIndex = newIndex;
                    localStorage.setItem('currentProfileIndex', currentProfileIndex);
                    updateUiForProfileSwitch();
                }
            }
        }

        function updateButtonVisibility() {
            // Add button
            addBusinessProfileBtn.style.display = businessProfiles.length < 4 ? 'flex' : 'none';
            // Delete button
            deleteBusinessProfileBtn.style.display = businessProfiles.length > 1 ? 'block' : 'none';
        }

        // --- End of Refactored Section ---

        // Letterhead handling
        letterheadUploadArea.addEventListener('click', () => letterheadInput.click());
        letterheadPreview.addEventListener('click', () => letterheadInput.click());

        letterheadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;

            if (file.size > 2 * 1024 * 1024) {
                alert('Image size should be less than 2MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const imgData = event.target.result;

                // Save letterhead to its own localStorage item, indexed by the profile
                localStorage.setItem(`businessLetterhead_${currentProfileIndex}`, imgData);
                
                // Update UI
                letterheadPreview.src = imgData;
                letterheadPreview.classList.remove('hidden');
                letterheadUploadArea.classList.add('hidden');
                updatePreview();
            };
            reader.readAsDataURL(file);
        });

        // LLM Prompt Helper
        copyPromptBtn.addEventListener('click', function() {
            const llmPrompt = `You are a helpful assistant that converts invoice details into structured JSON format for an invoice generator.

Please convert the following invoice details into JSON format. Use these field names:
- businessName (optional)
- yourName (optional)
- phoneNumber (optional)
- businessAddress (optional)
- clientName (optional)
- clientAddress (optional)
- invoiceDate (optional, format: YYYY-MM-DD, the date the invoice is sent)
- workStartDate (optional, format: YYYY-MM-DD, the start date of work performed)
- workEndDate (optional, format: YYYY-MM-DD, the end date of work performed)
- services (optional, string with line breaks)
- fee (optional, number)
- notes (optional)
- invoiceNumber (ONLY include if explicitly specified in the details - DO NOT auto-generate)

IMPORTANT: Do NOT include an invoiceNumber field unless it is explicitly mentioned in the invoice details below.

Return ONLY valid JSON, nothing else. If a field is not mentioned, omit it from the JSON.

Invoice details:
${llmInput.value || '(No details provided - generate empty JSON template)'}`;

            navigator.clipboard.writeText(llmPrompt).then(() => {
                copiedMessage.classList.remove('hidden');
                setTimeout(() => {
                    copiedMessage.classList.add('hidden');
                }, 3000);
            }).catch(err => {
                alert('Failed to copy to clipboard');
            });
        });

        // JSON Import
        importBtn.addEventListener('click', function() {
            try {
                const data = JSON.parse(importJson.value);

                // Populate fields from JSON
                if (data.clientName !== undefined) clientNameInput.value = data.clientName;
                if (data.clientAddress !== undefined) clientAddressInput.value = data.clientAddress;
                if (data.invoiceDate !== undefined) invoiceDateInput.value = data.invoiceDate;
                if (data.workStartDate !== undefined) workStartDateInput.value = data.workStartDate;
                if (data.workEndDate !== undefined) workEndDateInput.value = data.workEndDate;
                if (data.services !== undefined) servicesInput.value = data.services;
                if (data.fee !== undefined) feeInput.value = data.fee;
                if (data.notes !== undefined) notesInput.value = data.notes;
                if (data.invoiceNumber !== undefined) invoiceNumberInput.value = data.invoiceNumber;

                // Generate PDF immediately
                generatePDF();
            } catch (e) {
                alert('Invalid JSON format. Please check your data and try again.\n\nError: ' + e.message);
            }
        });

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const adjustedDate = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
            return adjustedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Parse invoice number
        function parseInvoiceNumber(input) {
            if (!input) return null;
            // Extract number from input (e.g., "45" or "INV-045" -> 45)
            const match = input.match(/\d+/);
            return match ? parseInt(match[0], 10) : null;
        }

        // Format invoice number
        function formatInvoiceNumber(num) {
            return `INV-${num.toString().padStart(3, '0')}`;
        }

        function updatePreview() {
            // From section
            const hasFrom = businessNameInput.value || yourNameInput.value || phoneNumberInput.value || businessAddressInput.value;
            const fromSection = document.getElementById('previewFromSection');
            fromSection.style.display = hasFrom ? 'block' : 'none';
            document.getElementById('previewBusinessName').textContent = businessNameInput.value;
            document.getElementById('previewYourName').textContent = yourNameInput.value;
            document.getElementById('previewPhone').textContent = phoneNumberInput.value;
            document.getElementById('previewBusinessAddress').textContent = businessAddressInput.value;

            // To section
            const hasTo = clientNameInput.value || clientAddressInput.value;
            const toSection = document.getElementById('previewToSection');
            toSection.style.display = hasTo ? 'block' : 'none';
            document.getElementById('previewClientName').textContent = clientNameInput.value;
            document.getElementById('previewClientAddress').textContent = clientAddressInput.value;

            // Invoice number
            let displayNumber = invoiceNumberInput.value;
            if (displayNumber) {
                const parsed = parseInvoiceNumber(displayNumber);
                if (parsed !== null) {
                    displayNumber = formatInvoiceNumber(parsed);
                }
            } else {
                displayNumber = invoiceNumberInput.placeholder;
            }
            document.getElementById('invoiceNumberPreview').textContent = '#' + displayNumber;

            // Invoice date
            const dateSection = document.getElementById('previewDateSection');
            dateSection.style.display = invoiceDateInput.value ? 'block' : 'none';
            document.getElementById('previewInvoiceDate').textContent = formatDate(invoiceDateInput.value);

            // Work period dates (service date section)
            const serviceDateSection = document.getElementById('previewServiceDateSection');
            const hasWorkDates = workStartDateInput.value || workEndDateInput.value;
            serviceDateSection.style.display = hasWorkDates ? 'block' : 'none';

            const workStartDate = formatDate(workStartDateInput.value);
            const workEndDate = formatDate(workEndDateInput.value);

            let serviceDateText = '';
            if (workStartDate && workEndDate) {
                serviceDateText = `${workStartDate} - ${workEndDate}`;
            } else if (workStartDate) {
                serviceDateText = `From ${workStartDate}`;
            } else if (workEndDate) {
                serviceDateText = `Until ${workEndDate}`;
            }

            document.getElementById('previewServiceDate').textContent = serviceDateText;

            // Services
            const servicesSection = document.getElementById('previewServicesSection');
            servicesSection.style.display = servicesInput.value ? 'block' : 'none';
            document.getElementById('previewServices').textContent = servicesInput.value;

            // Fee
            const feeSection = document.getElementById('previewFeeSection');
            feeSection.style.display = feeInput.value ? 'block' : 'none';
            document.getElementById('previewFee').textContent = feeInput.value ? `$${parseFloat(feeInput.value).toFixed(2)}` : '$0.00';

            // Notes
            const notesSection = document.getElementById('previewNotesSection');
            notesSection.style.display = notesInput.value ? 'block' : 'none';
            document.getElementById('previewNotes').textContent = notesInput.value;

            // Letterhead
            const previewLetterhead = document.getElementById('previewLetterhead');
            const previewLetterheadImg = document.getElementById('previewLetterheadImg');
            const savedLetterhead = localStorage.getItem(`businessLetterhead_${currentProfileIndex}`);
            if (savedLetterhead) {
                previewLetterheadImg.src = savedLetterhead;
                previewLetterhead.classList.remove('hidden');
            } else {
                previewLetterhead.classList.add('hidden');
            }
        }

        function generatePDF() {
            const doc = new jsPDF();
            let yPos = 20;
            const pageWidth = doc.internal.pageSize.width;
            const col1 = 20;
            const col2 = pageWidth / 2 + 10;
            const currentProfile = businessProfiles[currentProfileIndex];

            // Add letterhead if exists
            const savedLetterhead = localStorage.getItem(`businessLetterhead_${currentProfileIndex}`);
            if (savedLetterhead) {
                try {
                    const img = new Image();
                    img.src = savedLetterhead;
                    const imgWidth = 60;
                    const imgHeight = (img.height / img.width) * imgWidth;
                    doc.addImage(savedLetterhead, 'PNG', (pageWidth - imgWidth) / 2, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 10;
                } catch (e) {
                    console.error('Error adding letterhead to PDF:', e);
                }
            }

            // Invoice header
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(139, 111, 71); // Oak-600
            doc.text('INVOICE', 105, yPos, { align: 'center' });
            yPos += 12;

            // Determine invoice number
            const lastInvoiceNum = currentProfile.lastInvoiceNumber || 0;
            const enteredNum = parseInvoiceNumber(invoiceNumberInput.value);
            const usedNumber = enteredNum !== null ? enteredNum : lastInvoiceNum + 1;
            const invoiceNumStr = formatInvoiceNumber(usedNumber);
            
            doc.setFontSize(11);
            doc.setTextColor(75, 85, 99);
            doc.setFont(undefined, 'normal');

            if (invoiceDateInput.value) {
                doc.text(`#${invoiceNumStr} | ${formatDate(invoiceDateInput.value)}`, 105, yPos, { align: 'center' });
            } else {
                doc.text(`#${invoiceNumStr}`, 105, yPos, { align: 'center' });
            }
            yPos += 20;

            // From and To sections
            let fromYPos = yPos;
            let toYPos = yPos;
            const hasFrom = businessNameInput.value || yourNameInput.value || phoneNumberInput.value || businessAddressInput.value;
            const hasTo = clientNameInput.value || clientAddressInput.value;

            if (hasFrom) {
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                doc.text('FROM:', col1, fromYPos);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(31, 41, 55);
                fromYPos += 6;
                if (businessNameInput.value) {
                    doc.setFont(undefined, 'bold');
                    doc.text(businessNameInput.value, col1, fromYPos);
                    doc.setFont(undefined, 'normal');
                    fromYPos += 5;
                }
                if (yourNameInput.value) {
                    doc.text(yourNameInput.value, col1, fromYPos);
                    fromYPos += 5;
                }
                if (phoneNumberInput.value) {
                    doc.text(phoneNumberInput.value, col1, fromYPos);
                    fromYPos += 5;
                }
                if (businessAddressInput.value) {
                    const addressLines = doc.splitTextToSize(businessAddressInput.value, pageWidth / 2 - 20);
                    doc.text(addressLines, col1, fromYPos);
                    fromYPos += (addressLines.length * 5);
                }
            }

            if (hasTo) {
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                doc.text('BILL TO:', col2, toYPos);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(31, 41, 55);
                toYPos += 6;
                if (clientNameInput.value) {
                    doc.setFont(undefined, 'bold');
                    doc.text(clientNameInput.value, col2, toYPos);
                    doc.setFont(undefined, 'normal');
                    toYPos += 5;
                }
                if (clientAddressInput.value) {
                    const addressLines = doc.splitTextToSize(clientAddressInput.value, pageWidth / 2 - 20);
                    doc.text(addressLines, col2, toYPos);
                    toYPos += (addressLines.length * 5);
                }
            }

            yPos = Math.max(fromYPos, toYPos);
            if (hasFrom || hasTo) {
                yPos += 10;
            }

            // Work period
            const hasWorkDates = workStartDateInput.value || workEndDateInput.value;
            if (hasWorkDates) {
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                const workStartDate = formatDate(workStartDateInput.value);
                const workEndDate = formatDate(workEndDateInput.value);

                let serviceDateText = '';
                if (workStartDate && workEndDate) {
                    serviceDateText = `WORK PERIOD: ${workStartDate} - ${workEndDate}`;
                } else if (workStartDate) {
                    serviceDateText = `WORK START DATE: ${workStartDate}`;
                } else if (workEndDate) {
                    serviceDateText = `WORK END DATE: ${workEndDate}`;
                }

                doc.text(serviceDateText, col1, yPos);
                yPos += 10;
            }

            // Services
            if (servicesInput.value) {
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                doc.text('DESCRIPTION:', col1, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setTextColor(31, 41, 55);
                const serviceLines = doc.splitTextToSize(servicesInput.value, pageWidth - 40);
                doc.text(serviceLines, col1, yPos);
                yPos += (serviceLines.length * 5) + 12;
            }

            // Total
            if (feeInput.value) {
                doc.setLineWidth(0.5);
                doc.setDrawColor(209, 213, 219);
                doc.line(col1, yPos, pageWidth - 20, yPos);
                yPos += 8;

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(31, 41, 55);
                doc.text('TOTAL AMOUNT DUE:', col1, yPos);
                doc.setFontSize(20);
                doc.setTextColor(139, 111, 71); // Oak-600
                doc.text(`$${parseFloat(feeInput.value).toFixed(2)}`, pageWidth - 20, yPos, { align: 'right' });
                yPos += 12;
            }

            // Notes
            if (notesInput.value) {
                doc.setLineWidth(0.5);
                doc.setDrawColor(229, 231, 235);
                doc.line(col1, yPos, pageWidth - 20, yPos);
                yPos += 8;

                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                doc.text('NOTES:', col1, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setTextColor(55, 65, 81);
                const noteLines = doc.splitTextToSize(notesInput.value, pageWidth - 40);
                doc.text(noteLines, col1, yPos);
            }

            // Save PDF
            const fileNameBase = clientNameInput.value || 'invoice';
            const dateStr = new Date().toISOString().slice(0, 10);
            const fileName = `invoice_${fileNameBase.replace(/\s+/g, '_')}_${dateStr}.pdf`;
            doc.save(fileName);

            // Update invoice number tracking for current business profile
            if (currentProfile) {
                currentProfile.lastInvoiceNumber = usedNumber;
                persistProfiles();
            }

            // Update placeholder for next invoice
            invoiceNumberInput.placeholder = formatInvoiceNumber(usedNumber + 1);
            invoiceNumberInput.value = '';

            // Show success message
            successMessage.classList.remove('hidden');
            successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 5000);

            updatePreview();
        }

        // Fill demo data
        function fillDemoData() {
            const today = new Date().toISOString().slice(0, 10);
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

            clientNameInput.value = 'Pied Piper Solutions';
            clientAddressInput.value = '123 Innovation Blvd\nTech Park, CA 94103';

            invoiceDateInput.value = today;
            workStartDateInput.value = today;
            workEndDateInput.value = nextWeek;

            servicesInput.value = 'Magical Code Transmutation Services\n- Converting coffee into functional software\n- Reality distortion field maintenance\n- Quantum bug hunting and extermination';

            feeInput.value = '1234.56';
            notesInput.value = 'Note: Any existential crises caused by our reality-bending services are included at no extra cost.';

            updatePreview();
            invoicePreview.classList.remove('hidden');
            invoicePreview.scrollIntoView({ behavior: 'smooth' });
        }

        // --- Event Listeners and Initialization ---

        // Get the add/remove buttons
        const addBusinessProfileBtn = document.getElementById('addBusinessProfileBtn');
        const deleteBusinessProfileBtn = document.getElementById('deleteBusinessProfileBtn');

        window.addEventListener('DOMContentLoaded', () => {
            loadProfiles();
            updateUiForProfileSwitch();

            // Set default invoice date
            if (!invoiceDateInput.value) {
                invoiceDateInput.value = new Date().toISOString().slice(0, 10);
            }

            // Initialize import button in unselected state
            importModeButton.classList.remove('import-button-selected');
            
            checkAutoCollapse();

            // Re-add listeners for main actions
            const formInputs = [
                businessNameInput, yourNameInput, phoneNumberInput, businessAddressInput,
                invoiceNumberInput, clientNameInput, clientAddressInput,
                invoiceDateInput, workStartDateInput, workEndDateInput, servicesInput, feeInput, notesInput
            ];

            formInputs.forEach(input => {
                input.addEventListener('input', updatePreview);
            });

            previewBtn.addEventListener('click', () => {
                updatePreview();
                invoicePreview.classList.remove('hidden');
                invoicePreview.scrollIntoView({ behavior: 'smooth' });
            });

            generateBtn.addEventListener('click', generatePDF);
            fillDemoBtn.addEventListener('click', function() {
                if (confirm('Instafill will add witty sample data to all fields. Any existing data will be overwritten. Continue?')) {
                    fillDemoData();
                }
            });
        });

        // Add event listeners for the profile buttons
        addBusinessProfileBtn.addEventListener('click', addNewBusinessProfile);
        deleteBusinessProfileBtn.addEventListener('click', removeBusinessProfile);

        // Auto-save business details on blur
        const profileInputs = [businessNameInput, yourNameInput, phoneNumberInput, businessAddressInput];
        profileInputs.forEach(input => {
            input.addEventListener('blur', saveCurrentProfileData);
        });

        // Update business profile tab label when business name changes
        businessNameInput.addEventListener('input', function() {
            const tabButton = document.querySelector(`button[data-profile-index="${currentProfileIndex}"]`);
            if (tabButton) {
                tabButton.textContent = this.value || `Business ${currentProfileIndex + 1}`;
            }
        });
    </script>
</body>
</html>
