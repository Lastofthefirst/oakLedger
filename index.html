<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3E2723">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Oak Ledger - Invoice Generator</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“„</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="styles.css">

</head>
<body class="h-full bg-oak-50 text-oak-900">
    <div class="min-h-full">
        <!-- Header -->
        <header class="app-header">
            <div class="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
                <div class="flex flex-col items-center gap-6">
                    <!-- App Title -->
                    <div class="text-center fade-in">
                        <h1 style="font-family: var(--font-serif); font-size: 3.5rem; font-weight: 700; letter-spacing: -0.03em; text-shadow: 0 4px 12px rgba(0,0,0,0.3); color: var(--color-oak-50); line-height: 1;">
                            Oak Ledger
                        </h1>
                        <p class="mt-2 text-sm text-oak-200 font-medium" style="letter-spacing: 0.15em; text-transform: uppercase; opacity: 0.9;">
                            Hassle-Free Invoice Generator
                        </p>
                    </div>

                    <!-- Letterhead Upload Area -->
                    <div id="letterheadContainer" class="w-full flex justify-center fade-in-up stagger-1">
                        <div class="bg-white rounded-lg px-6 py-5 card" style="max-width: 340px; border: 1px solid rgba(154, 123, 90, 0.15);">
                            <div id="letterheadUploadArea" class="letterhead-upload-area rounded-lg px-5 py-4 text-center cursor-pointer">
                                <svg class="mx-auto h-10 w-10 text-oak-500 transition-all duration-300 hover:text-oak-600 hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <p class="mt-2 text-sm font-semibold text-oak-700">Upload Letterhead</p>
                                <p class="text-xs text-oak-500 mt-1">PNG, JPG, SVG up to 2MB</p>
                            </div>
                            <img id="letterheadPreview" class="letterhead-preview hidden mt-3 mx-auto" alt="Letterhead">
                        </div>
                    </div>
                    <input type="file" id="letterheadInput" accept="image/*">
                </div>
            </div>
        </header>

        <main class="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
            <!-- Import Mode Button -->
            <div class="mb-8 flex items-center justify-end gap-3">
                <button id="importModeButton" type="button" class="btn btn-ghost">
                    <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Import
                </button>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="hidden mb-8 success-message p-4 fade-in">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-semibold text-green-800">Invoice created successfully! Check your downloads.</p>
                    </div>
                </div>
            </div>

            <!-- Import Mode Section -->
            <div id="importSection" class="hidden mb-8 space-y-6 fade-in-up">
                <!-- LLM Prompt Helper -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-lg font-semibold text-oak-800">LLM Assistant</h2>
                        <p class="mt-1 text-sm text-oak-500">Paste invoice details below, then copy the prompt to use with an LLM</p>
                    </div>
                    <div class="px-6 py-6 space-y-5">
                        <div>
                            <label for="llmInput" class="form-label">Invoice Details (Plain Text)</label>
                            <textarea id="llmInput" rows="4" placeholder="Paste or type invoice details here (optional)..."
                                class="form-input w-full"></textarea>
                        </div>
                        <button id="copyPromptBtn" type="button" class="btn btn-primary w-full">
                            <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            Copy LLM Prompt
                        </button>
                        <p id="copiedMessage" class="hidden text-sm text-green-600 text-center font-medium">Copied to clipboard!</p>
                    </div>
                </div>

                <!-- JSON Import -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-lg font-semibold text-oak-800">Import Invoice Data</h2>
                        <p class="mt-1 text-sm text-oak-500">Paste JSON data structure to populate fields</p>
                    </div>
                    <div class="px-6 py-6 space-y-5">
                        <div>
                            <label for="importJson" class="form-label">JSON Data</label>
                            <textarea id="importJson" rows="6" placeholder='{"clientName": "Acme Corp", "fee": 500, ...}'
                                class="form-input w-full font-mono text-sm"></textarea>
                        </div>
                        <button id="importBtn" type="button" class="btn btn-primary w-full">
                            <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Import & Generate PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Normal Mode Section -->
            <div id="normalSection">
                <!-- Business Details Card -->
                <div class="mb-8 card fade-in-up">
                    <div class="card-header cursor-pointer" id="businessHeader">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-lg font-semibold text-oak-800">Your Business Details</h2>
                                <p class="mt-1 text-sm text-oak-500">Saved information for your invoices</p>
                            </div>
                            <svg id="businessChevron" class="chevron-icon h-5 w-5 text-oak-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div id="businessContent" class="px-6 py-6 space-y-5">
                        <!-- Business Profile Tabs -->
                        <div class="mb-2">
                            <div class="flex flex-wrap justify-between items-end gap-2 mb-0">
                                <div id="businessProfileTabs" class="flex flex-wrap gap-1"></div>
                                <button id="addBusinessProfileBtn" type="button"
                                    class="btn-ghost px-3 py-2 text-sm font-semibold rounded-lg flex items-center justify-center"
                                    title="Add new business profile">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                            </div>
                            <div class="section-divider"></div>
                        </div>
                        <!-- Business Profile Delete Button -->
                        <div class="flex justify-end -mt-2">
                            <button id="deleteBusinessProfileBtn" type="button"
                                class="px-3 py-1 text-xs font-medium rounded-lg text-red-600 hover:bg-red-50 hidden"
                                title="Remove this business profile">Remove Profile</button>
                        </div>

                        <div>
                            <label for="businessName" class="form-label">Business Name</label>
                            <input type="text" id="businessName" placeholder="Your Business Name"
                                class="form-input w-full">
                        </div>
                        <div>
                            <label for="yourName" class="form-label">Your Name</label>
                            <input type="text" id="yourName" placeholder="Your Full Name"
                                class="form-input w-full">
                        </div>
                        <div>
                            <label for="phoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" id="phoneNumber" placeholder="(123) 456-7890"
                                class="form-input w-full">
                        </div>
                        <div>
                            <label for="businessAddress" class="form-label">Business Address</label>
                            <textarea id="businessAddress" rows="3" placeholder="123 Your Street&#10;City, State ZIP"
                                class="form-input w-full"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Invoice Details Card -->
                <div class="mb-8 card fade-in-up">
                    <div class="card-header">
                        <h2 class="text-lg font-semibold text-oak-800">Invoice Details</h2>
                        <p class="mt-1 text-sm text-oak-500">Fill in the details for this invoice</p>
                    </div>
                    <div class="px-6 py-6 space-y-5">
                        <div>
                            <label for="invoiceNumber" class="form-label">
                                Invoice Number <span class="text-oak-400 font-normal">(Auto)</span>
                            </label>
                            <input type="text" id="invoiceNumber" placeholder="INV-0001"
                                class="form-input w-full font-mono">
                            <p class="mt-1.5 text-xs text-oak-400">Leave blank for auto-increment, or enter a custom number</p>
                        </div>

                        <div class="section-divider"></div>

                        <div class="input-wrapper">
                            <label for="clientName" class="form-label">Client Name</label>
                            <input type="text" id="clientName" placeholder="Client's Name or Company"
                                class="form-input w-full pr-10">
                            <button type="button" class="clear-btn text-oak-400 hover:text-oak-600" onclick="document.getElementById('clientName').value = ''; updatePreview();">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <div class="textarea-wrapper input-wrapper">
                            <label for="clientAddress" class="form-label">Client Address</label>
                            <textarea id="clientAddress" rows="3" placeholder="123 Main Street&#10;Anytown, USA 12345"
                                class="form-input w-full pr-10"></textarea>
                            <button type="button" class="clear-btn text-oak-400 hover:text-oak-600" onclick="document.getElementById('clientAddress').value = ''; updatePreview();">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <div class="section-divider"></div>

                        <div>
                            <label for="invoiceDate" class="form-label">Invoice Date</label>
                            <input type="date" id="invoiceDate" class="form-input w-full">
                        </div>

                        <div>
                            <label class="form-label">Work Period</label>
                            <div class="rounded-lg p-4" style="background: linear-gradient(135deg, var(--color-oak-50) 0%, rgba(255,255,255,0.5) 100%); border: 1px solid var(--color-oak-100);">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="workStartDate" class="text-xs font-medium text-oak-600 mb-1.5 block">Start Date</label>
                                        <input type="date" id="workStartDate" class="form-input w-full">
                                    </div>
                                    <div>
                                        <label for="workEndDate" class="text-xs font-medium text-oak-600 mb-1.5 block">End Date</label>
                                        <input type="date" id="workEndDate" class="form-input w-full">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="section-divider"></div>

                        <div>
                            <label for="services" class="form-label">Services Provided</label>
                            <textarea id="services" rows="4" placeholder="e.g., Web Design Services&#10;- Homepage Mockup&#10;- Contact Form Integration"
                                class="form-input w-full"></textarea>
                        </div>

                        <div>
                            <label for="fee" class="form-label">Amount ($)</label>
                            <input type="number" id="fee" placeholder="0.00" step="0.01"
                                class="form-input w-full" style="font-size: 1.125rem; font-weight: 600;">
                        </div>

                        <div>
                            <label for="notes" class="form-label">Notes</label>
                            <textarea id="notes" rows="3" placeholder="e.g., Payment due within 30 days."
                                class="form-input w-full"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 mb-10">
                    <div class="flex gap-3 flex-1">
                        <button id="previewBtn" type="button" class="btn btn-secondary flex-1">
                            <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            Preview
                        </button>
                        <button id="fillDemoBtn" type="button" title="Fill with sample data" class="btn btn-ghost px-3">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                        </button>
                    </div>
                    <button id="generateBtn" type="button" class="btn btn-primary flex-1 sm:flex-none" style="padding-left: 2rem; padding-right: 2rem;">
                        <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Create PDF
                    </button>
                </div>
            </div>

                <!-- Preview Card -->
                <div id="invoicePreview" class="hidden invoice-preview-card bg-white border border-oak-200 fade-in-up" style="margin-top: 3rem;">
                    <div class="invoice-preview-header" style="background: linear-gradient(135deg, var(--color-oak-700) 0%, var(--color-oak-900) 100%); padding: 1.5rem 2rem;">
                        <h3 class="text-lg font-semibold" style="font-family: var(--font-serif); color: #FFFFFF;">Invoice Preview</h3>
                    </div>
                    <div style="padding: 3rem 2rem; max-width: 900px; margin: 0 auto;" class="text-oak-900">
                        <!-- Letterhead in preview -->
                        <div id="previewLetterhead" class="mb-12 text-center hidden">
                            <img id="previewLetterheadImg" class="mx-auto max-h-24 object-contain" alt="Letterhead">
                        </div>

                        <!-- Invoice Title Row -->
                        <div class="flex justify-between items-start mb-16">
                            <div style="font-family: var(--font-serif); font-size: 2.5rem; font-weight: 700; letter-spacing: -0.02em; color: var(--color-oak-800);">INVOICE</div>
                            <div id="invoiceNumberPreview" class="text-lg font-bold text-oak-600 px-4 py-2 rounded-lg" style="background: linear-gradient(135deg, var(--color-oak-50) 0%, var(--color-oak-100) 100%); font-family: var(--font-mono);">#INV-0001</div>
                        </div>

                        <!-- From/To Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-16">
                            <div id="previewFromSection" class="hidden">
                                <div class="text-xs font-bold text-oak-400 uppercase tracking-wide mb-4" style="letter-spacing: 0.1em;">From</div>
                                <div id="previewBusinessName" class="font-bold text-oak-800 text-xl mb-2" style="font-family: var(--font-serif); line-height: 1.3;"></div>
                                <div id="previewYourName" class="text-oak-600 mb-1" style="font-size: 0.9375rem;"></div>
                                <div id="previewPhone" class="text-oak-600 mb-3" style="font-size: 0.9375rem;"></div>
                                <div id="previewBusinessAddress" class="text-oak-600 whitespace-pre-line" style="font-size: 0.9375rem; line-height: 1.6;"></div>
                            </div>

                            <div id="previewToSection" class="hidden">
                                <div class="text-xs font-bold text-oak-400 uppercase tracking-wide mb-4" style="letter-spacing: 0.1em;">Bill To</div>
                                <div id="previewClientName" class="font-bold text-oak-800 text-xl mb-2" style="font-family: var(--font-serif); line-height: 1.3;"></div>
                                <div id="previewClientAddress" class="text-oak-600 whitespace-pre-line" style="font-size: 0.9375rem; line-height: 1.6;"></div>
                            </div>
                        </div>

                        <!-- Date Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-16 pb-12" style="border-bottom: 1px solid rgba(154, 123, 90, 0.15);">
                            <div id="previewDateSection" class="hidden">
                                <div class="text-xs font-bold text-oak-400 uppercase tracking-wide mb-3" style="letter-spacing: 0.1em;">Invoice Date</div>
                                <div id="previewInvoiceDate" class="text-oak-800 font-semibold text-lg"></div>
                            </div>

                            <div id="previewServiceDateSection" class="hidden">
                                <div class="text-xs font-bold text-oak-400 uppercase tracking-wide mb-3" style="letter-spacing: 0.1em;">Service Period</div>
                                <div id="previewServiceDate" class="text-oak-800 font-semibold text-lg"></div>
                            </div>
                        </div>

                        <!-- Services Section -->
                        <div id="previewServicesSection" class="mb-16 hidden">
                            <div class="text-xs font-bold text-oak-400 uppercase tracking-wide mb-4" style="letter-spacing: 0.1em;">Description of Services</div>
                            <div id="previewServices" class="text-oak-700 whitespace-pre-line" style="font-size: 0.9375rem; line-height: 1.8;"></div>
                        </div>

                        <!-- Total Section -->
                        <div id="previewFeeSection" class="mb-12 hidden pt-12" style="border-top: 2px solid var(--color-oak-300);">
                            <div class="flex justify-between items-center py-6 px-8 rounded-xl" style="background: linear-gradient(135deg, rgba(250, 247, 242, 0.5) 0%, rgba(255, 255, 255, 0.3) 100%);">
                                <div style="font-family: var(--font-serif); font-size: 1.5rem; font-weight: 600; color: var(--color-oak-700);">Total Amount Due</div>
                                <div id="previewFee" style="font-family: var(--font-serif); font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--color-oak-600) 0%, var(--color-oak-800) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div id="previewNotesSection" class="hidden pt-8" style="border-top: 1px solid rgba(154, 123, 90, 0.12);">
                            <div class="text-xs font-bold text-oak-400 uppercase tracking-wide mb-3" style="letter-spacing: 0.1em;">Payment Terms & Notes</div>
                            <div id="previewNotes" class="text-oak-600 whitespace-pre-line" style="font-size: 0.9375rem; line-height: 1.7;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer mt-12 py-8">
            <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col items-center gap-4">
                    <p class="text-sm font-medium text-oak-50">Oak Ledger</p>
                    <p class="text-xs text-oak-200" style="opacity: 0.9;">All data stored securely on your device</p>

                    <!-- Built by Section -->
                    <div class="flex flex-col items-center gap-2 mt-4 pt-4" style="border-top: 1px solid rgba(201, 168, 105, 0.3);">
                        <p class="text-xs text-oak-200 font-medium">Built by</p>
                        <a href="https://ridvan.org" target="_blank" rel="noopener noreferrer"
                           class="transition-all duration-300 hover:scale-105"
                           style="display: block; opacity: 1;">
                            <img src="ridvand.0ccc840f-opt-256.WEBP" alt="Ridvan" style="height: 48px; width: auto;">
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered', reg))
                .catch(err => console.log('Service Worker registration failed', err));
        }

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // Global state

        // DOM Elements
        const importModeButton = document.getElementById('importModeButton');
        const importSection = document.getElementById('importSection');
        const normalSection = document.getElementById('normalSection');
        const businessHeader = document.getElementById('businessHeader');
        const businessContent = document.getElementById('businessContent');
        const businessChevron = document.getElementById('businessChevron');

        const businessNameInput = document.getElementById('businessName');
        const yourNameInput = document.getElementById('yourName');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const businessAddressInput = document.getElementById('businessAddress');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const clientNameInput = document.getElementById('clientName');
        const clientAddressInput = document.getElementById('clientAddress');
        const invoiceDateInput = document.getElementById('invoiceDate');
        const workStartDateInput = document.getElementById('workStartDate');
        const workEndDateInput = document.getElementById('workEndDate');
        const servicesInput = document.getElementById('services');
        const feeInput = document.getElementById('fee');
        const notesInput = document.getElementById('notes');

        const previewBtn = document.getElementById('previewBtn');
        const generateBtn = document.getElementById('generateBtn');
        const fillDemoBtn = document.getElementById('fillDemoBtn');
        const invoicePreview = document.getElementById('invoicePreview');
        const successMessage = document.getElementById('successMessage');

        const letterheadInput = document.getElementById('letterheadInput');
        const letterheadUploadArea = document.getElementById('letterheadUploadArea');
        const letterheadPreview = document.getElementById('letterheadPreview');

        const llmInput = document.getElementById('llmInput');
        const copyPromptBtn = document.getElementById('copyPromptBtn');
        const copiedMessage = document.getElementById('copiedMessage');
        const importJson = document.getElementById('importJson');
        const importBtn = document.getElementById('importBtn');

        // Import Mode Button
        let isImportMode = false;
        importModeButton.addEventListener('click', function() {
            isImportMode = !isImportMode;

            if (isImportMode) {
                // Switch to import mode
                importSection.classList.remove('hidden');
                normalSection.classList.add('hidden');
                importModeButton.classList.add('import-button-selected');
            } else {
                // Switch back to normal mode
                importSection.classList.add('hidden');
                normalSection.classList.remove('hidden');
                importModeButton.classList.remove('import-button-selected');
            }
        });

        // Collapsible Business Section
        let businessCollapsed = false;
        businessHeader.addEventListener('click', function() {
            businessCollapsed = !businessCollapsed;
            if (businessCollapsed) {
                businessContent.classList.add('hidden');
                businessChevron.classList.add('collapsed');
            } else {
                businessContent.classList.remove('hidden');
                businessChevron.classList.remove('collapsed');
            }
        });

        function checkAutoCollapse() {
            const profile = businessProfiles[currentProfileIndex];
            if (profile && (profile.businessName || profile.yourName)) {
                businessCollapsed = true;
                businessContent.classList.add('hidden');
                businessChevron.classList.add('collapsed');
            }
        }

        // --- Business Profile Management (Refactored) ---

        let businessProfiles = [];
        let currentProfileIndex = 0;

        function createEmptyProfile() {
            return {
                businessName: '',
                yourName: '',
                phoneNumber: '',
                businessAddress: '',
                lastInvoiceNumber: 0
            };
        }

        function persistProfiles() {
            localStorage.setItem('businessProfiles', JSON.stringify(businessProfiles));
        }

        function loadProfiles() {
            const savedProfiles = localStorage.getItem('businessProfiles');
            if (savedProfiles && JSON.parse(savedProfiles).length > 0) {
                businessProfiles = JSON.parse(savedProfiles);
            } else {
                businessProfiles = [createEmptyProfile()];
            }
            currentProfileIndex = Math.min(Math.max(0, parseInt(localStorage.getItem('currentProfileIndex') || '0')), businessProfiles.length - 1);
        }

        function updateUiForProfileSwitch() {
            loadProfileData(currentProfileIndex);
            renderBusinessProfileTabs();
            updateButtonVisibility();
            updatePreview();
        }

        function saveCurrentProfileData() {
            const profile = businessProfiles[currentProfileIndex];
            if (!profile) return;

            profile.businessName = businessNameInput.value;
            profile.yourName = yourNameInput.value;
            profile.phoneNumber = phoneNumberInput.value;
            profile.businessAddress = businessAddressInput.value;
            
            persistProfiles();
        }

        function loadProfileData(index) {
            const profile = businessProfiles[index];
            if (!profile) return;

            businessNameInput.value = profile.businessName;
            yourNameInput.value = profile.yourName;
            phoneNumberInput.value = profile.phoneNumber;
            businessAddressInput.value = profile.businessAddress;

            const savedLetterhead = localStorage.getItem(`businessLetterhead_${index}`);
            if (savedLetterhead) {
                letterheadPreview.src = savedLetterhead;
                letterheadPreview.classList.remove('hidden');
                letterheadUploadArea.classList.add('hidden');
            } else {
                letterheadPreview.classList.add('hidden');
                letterheadUploadArea.classList.remove('hidden');
            }

            const lastInvoiceNumber = profile.lastInvoiceNumber || 0;
            invoiceNumberInput.placeholder = `INV-${(lastInvoiceNumber + 1).toString().padStart(3, '0')}`;
        }
        
        function renderBusinessProfileTabs() {
            const tabsContainer = document.getElementById('businessProfileTabs');
            tabsContainer.innerHTML = '';

            businessProfiles.forEach((profile, index) => {
                const tabButton = document.createElement('button');
                tabButton.type = 'button';
                tabButton.textContent = profile.businessName || `Business ${index + 1}`;
                tabButton.dataset.profileIndex = index;

                if (index === currentProfileIndex) {
                    tabButton.className = 'profile-tab active';
                } else {
                    tabButton.className = 'profile-tab';
                }

                tabButton.addEventListener('click', () => {
                    if (currentProfileIndex !== index) {
                        switchToProfile(index);
                    }
                });

                tabsContainer.appendChild(tabButton);
            });
        }

        function switchToProfile(index) {
            saveCurrentProfileData();
            currentProfileIndex = index;
            localStorage.setItem('currentProfileIndex', currentProfileIndex);
            updateUiForProfileSwitch();
        }

        function addNewBusinessProfile() {
            if (businessProfiles.length < 4) {
                saveCurrentProfileData();
                businessProfiles.push(createEmptyProfile());
                persistProfiles();
                switchToProfile(businessProfiles.length - 1);
            }
        }

        function removeBusinessProfile() {
            if (businessProfiles.length > 1) {
                if (confirm('Are you sure you want to remove this business profile?')) {
                    // Also remove associated separate data
                    localStorage.removeItem(`businessLetterhead_${currentProfileIndex}`);
                    
                    businessProfiles.splice(currentProfileIndex, 1);
                    persistProfiles();

                    // Adjust current index if we removed the last profile in the list
                    const newIndex = Math.min(currentProfileIndex, businessProfiles.length - 1);
                    
                    // No need to save here, just switch
                    currentProfileIndex = newIndex;
                    localStorage.setItem('currentProfileIndex', currentProfileIndex);
                    updateUiForProfileSwitch();
                }
            }
        }

        function updateButtonVisibility() {
            // Add button
            addBusinessProfileBtn.style.display = businessProfiles.length < 4 ? 'flex' : 'none';
            // Delete button
            deleteBusinessProfileBtn.style.display = businessProfiles.length > 1 ? 'block' : 'none';
        }

        // --- End of Refactored Section ---

        // Letterhead handling
        letterheadUploadArea.addEventListener('click', () => letterheadInput.click());
        letterheadPreview.addEventListener('click', () => letterheadInput.click());

        letterheadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;

            if (file.size > 2 * 1024 * 1024) {
                alert('Image size should be less than 2MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const imgData = event.target.result;

                // Save letterhead to its own localStorage item, indexed by the profile
                localStorage.setItem(`businessLetterhead_${currentProfileIndex}`, imgData);
                
                // Update UI
                letterheadPreview.src = imgData;
                letterheadPreview.classList.remove('hidden');
                letterheadUploadArea.classList.add('hidden');
                updatePreview();
            };
            reader.readAsDataURL(file);
        });

        // LLM Prompt Helper
        copyPromptBtn.addEventListener('click', function() {
            const llmPrompt = `You are a helpful assistant that converts invoice details into structured JSON format for an invoice generator.

Please convert the following invoice details into JSON format. Use these field names:
- businessName (optional)
- yourName (optional)
- phoneNumber (optional)
- businessAddress (optional)
- clientName (optional)
- clientAddress (optional)
- invoiceDate (optional, format: YYYY-MM-DD, the date the invoice is sent)
- workStartDate (optional, format: YYYY-MM-DD, the start date of work performed)
- workEndDate (optional, format: YYYY-MM-DD, the end date of work performed)
- services (optional, string with line breaks)
- fee (optional, number)
- notes (optional)
- invoiceNumber (ONLY include if explicitly specified in the details - DO NOT auto-generate)

IMPORTANT: Do NOT include an invoiceNumber field unless it is explicitly mentioned in the invoice details below.

Return ONLY valid JSON, nothing else. If a field is not mentioned, omit it from the JSON.

Invoice details:
${llmInput.value || '(No details provided - generate empty JSON template)'}`;

            navigator.clipboard.writeText(llmPrompt).then(() => {
                copiedMessage.classList.remove('hidden');
                setTimeout(() => {
                    copiedMessage.classList.add('hidden');
                }, 3000);
            }).catch(err => {
                alert('Failed to copy to clipboard');
            });
        });

        // JSON Import
        importBtn.addEventListener('click', function() {
            try {
                const data = JSON.parse(importJson.value);

                // Populate fields from JSON
                if (data.clientName !== undefined) clientNameInput.value = data.clientName;
                if (data.clientAddress !== undefined) clientAddressInput.value = data.clientAddress;
                if (data.invoiceDate !== undefined) invoiceDateInput.value = data.invoiceDate;
                if (data.workStartDate !== undefined) workStartDateInput.value = data.workStartDate;
                if (data.workEndDate !== undefined) workEndDateInput.value = data.workEndDate;
                if (data.services !== undefined) servicesInput.value = data.services;
                if (data.fee !== undefined) feeInput.value = data.fee;
                if (data.notes !== undefined) notesInput.value = data.notes;
                if (data.invoiceNumber !== undefined) invoiceNumberInput.value = data.invoiceNumber;

                // Generate PDF immediately
                generatePDF();
            } catch (e) {
                alert('Invalid JSON format. Please check your data and try again.\n\nError: ' + e.message);
            }
        });

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const adjustedDate = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
            return adjustedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Parse invoice number
        function parseInvoiceNumber(input) {
            if (!input) return null;
            // Extract number from input (e.g., "45" or "INV-045" -> 45)
            const match = input.match(/\d+/);
            return match ? parseInt(match[0], 10) : null;
        }

        // Format invoice number
        function formatInvoiceNumber(num) {
            return `INV-${num.toString().padStart(3, '0')}`;
        }

        function updatePreview() {
            // From section
            const hasFrom = businessNameInput.value || yourNameInput.value || phoneNumberInput.value || businessAddressInput.value;
            const fromSection = document.getElementById('previewFromSection');
            fromSection.style.display = hasFrom ? 'block' : 'none';
            document.getElementById('previewBusinessName').textContent = businessNameInput.value;
            document.getElementById('previewYourName').textContent = yourNameInput.value;
            document.getElementById('previewPhone').textContent = phoneNumberInput.value;
            document.getElementById('previewBusinessAddress').textContent = businessAddressInput.value;

            // To section
            const hasTo = clientNameInput.value || clientAddressInput.value;
            const toSection = document.getElementById('previewToSection');
            toSection.style.display = hasTo ? 'block' : 'none';
            document.getElementById('previewClientName').textContent = clientNameInput.value;
            document.getElementById('previewClientAddress').textContent = clientAddressInput.value;

            // Invoice number
            let displayNumber = invoiceNumberInput.value;
            if (displayNumber) {
                const parsed = parseInvoiceNumber(displayNumber);
                if (parsed !== null) {
                    displayNumber = formatInvoiceNumber(parsed);
                }
            } else {
                displayNumber = invoiceNumberInput.placeholder;
            }
            document.getElementById('invoiceNumberPreview').textContent = '#' + displayNumber;

            // Invoice date
            const dateSection = document.getElementById('previewDateSection');
            dateSection.style.display = invoiceDateInput.value ? 'block' : 'none';
            document.getElementById('previewInvoiceDate').textContent = formatDate(invoiceDateInput.value);

            // Work period dates (service date section)
            const serviceDateSection = document.getElementById('previewServiceDateSection');
            const hasWorkDates = workStartDateInput.value || workEndDateInput.value;
            serviceDateSection.style.display = hasWorkDates ? 'block' : 'none';

            const workStartDate = formatDate(workStartDateInput.value);
            const workEndDate = formatDate(workEndDateInput.value);

            let serviceDateText = '';
            if (workStartDate && workEndDate) {
                serviceDateText = `${workStartDate} - ${workEndDate}`;
            } else if (workStartDate) {
                serviceDateText = `From ${workStartDate}`;
            } else if (workEndDate) {
                serviceDateText = `Until ${workEndDate}`;
            }

            document.getElementById('previewServiceDate').textContent = serviceDateText;

            // Services
            const servicesSection = document.getElementById('previewServicesSection');
            servicesSection.style.display = servicesInput.value ? 'block' : 'none';
            document.getElementById('previewServices').textContent = servicesInput.value;

            // Fee
            const feeSection = document.getElementById('previewFeeSection');
            feeSection.style.display = feeInput.value ? 'block' : 'none';
            document.getElementById('previewFee').textContent = feeInput.value ? `$${parseFloat(feeInput.value).toFixed(2)}` : '$0.00';

            // Notes
            const notesSection = document.getElementById('previewNotesSection');
            notesSection.style.display = notesInput.value ? 'block' : 'none';
            document.getElementById('previewNotes').textContent = notesInput.value;

            // Letterhead
            const previewLetterhead = document.getElementById('previewLetterhead');
            const previewLetterheadImg = document.getElementById('previewLetterheadImg');
            const savedLetterhead = localStorage.getItem(`businessLetterhead_${currentProfileIndex}`);
            if (savedLetterhead) {
                previewLetterheadImg.src = savedLetterhead;
                previewLetterhead.classList.remove('hidden');
            } else {
                previewLetterhead.classList.add('hidden');
            }
        }

        function generatePDF() {
            const doc = new jsPDF();
            let yPos = 20;
            const pageWidth = doc.internal.pageSize.width;
            const col1 = 20;
            const col2 = pageWidth / 2 + 10;
            const currentProfile = businessProfiles[currentProfileIndex];

            // Add letterhead if exists
            const savedLetterhead = localStorage.getItem(`businessLetterhead_${currentProfileIndex}`);
            if (savedLetterhead) {
                try {
                    const img = new Image();
                    img.src = savedLetterhead;
                    const imgWidth = 60;
                    const imgHeight = (img.height / img.width) * imgWidth;
                    doc.addImage(savedLetterhead, 'PNG', (pageWidth - imgWidth) / 2, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 10;
                } catch (e) {
                    console.error('Error adding letterhead to PDF:', e);
                }
            }

            // Invoice header
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(139, 111, 71); // Oak-600
            doc.text('INVOICE', 105, yPos, { align: 'center' });
            yPos += 12;

            // Determine invoice number
            const lastInvoiceNum = currentProfile.lastInvoiceNumber || 0;
            const enteredNum = parseInvoiceNumber(invoiceNumberInput.value);
            const usedNumber = enteredNum !== null ? enteredNum : lastInvoiceNum + 1;
            const invoiceNumStr = formatInvoiceNumber(usedNumber);
            
            doc.setFontSize(11);
            doc.setTextColor(75, 85, 99);
            doc.setFont(undefined, 'normal');

            if (invoiceDateInput.value) {
                doc.text(`#${invoiceNumStr} | ${formatDate(invoiceDateInput.value)}`, 105, yPos, { align: 'center' });
            } else {
                doc.text(`#${invoiceNumStr}`, 105, yPos, { align: 'center' });
            }
            yPos += 20;

            // From and To sections
            let fromYPos = yPos;
            let toYPos = yPos;
            const hasFrom = businessNameInput.value || yourNameInput.value || phoneNumberInput.value || businessAddressInput.value;
            const hasTo = clientNameInput.value || clientAddressInput.value;

            if (hasFrom) {
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                doc.text('FROM:', col1, fromYPos);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(31, 41, 55);
                fromYPos += 6;
                if (businessNameInput.value) {
                    doc.setFont(undefined, 'bold');
                    doc.text(businessNameInput.value, col1, fromYPos);
                    doc.setFont(undefined, 'normal');
                    fromYPos += 5;
                }
                if (yourNameInput.value) {
                    doc.text(yourNameInput.value, col1, fromYPos);
                    fromYPos += 5;
                }
                if (phoneNumberInput.value) {
                    doc.text(phoneNumberInput.value, col1, fromYPos);
                    fromYPos += 5;
                }
                if (businessAddressInput.value) {
                    const addressLines = doc.splitTextToSize(businessAddressInput.value, pageWidth / 2 - 20);
                    doc.text(addressLines, col1, fromYPos);
                    fromYPos += (addressLines.length * 5);
                }
            }

            if (hasTo) {
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                doc.text('BILL TO:', col2, toYPos);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(31, 41, 55);
                toYPos += 6;
                if (clientNameInput.value) {
                    doc.setFont(undefined, 'bold');
                    doc.text(clientNameInput.value, col2, toYPos);
                    doc.setFont(undefined, 'normal');
                    toYPos += 5;
                }
                if (clientAddressInput.value) {
                    const addressLines = doc.splitTextToSize(clientAddressInput.value, pageWidth / 2 - 20);
                    doc.text(addressLines, col2, toYPos);
                    toYPos += (addressLines.length * 5);
                }
            }

            yPos = Math.max(fromYPos, toYPos);
            if (hasFrom || hasTo) {
                yPos += 10;
            }

            // Work period
            const hasWorkDates = workStartDateInput.value || workEndDateInput.value;
            if (hasWorkDates) {
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                const workStartDate = formatDate(workStartDateInput.value);
                const workEndDate = formatDate(workEndDateInput.value);

                let serviceDateText = '';
                if (workStartDate && workEndDate) {
                    serviceDateText = `WORK PERIOD: ${workStartDate} - ${workEndDate}`;
                } else if (workStartDate) {
                    serviceDateText = `WORK START DATE: ${workStartDate}`;
                } else if (workEndDate) {
                    serviceDateText = `WORK END DATE: ${workEndDate}`;
                }

                doc.text(serviceDateText, col1, yPos);
                yPos += 10;
            }

            // Services
            if (servicesInput.value) {
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                doc.text('DESCRIPTION:', col1, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setTextColor(31, 41, 55);
                const serviceLines = doc.splitTextToSize(servicesInput.value, pageWidth - 40);
                doc.text(serviceLines, col1, yPos);
                yPos += (serviceLines.length * 5) + 12;
            }

            // Total
            if (feeInput.value) {
                doc.setLineWidth(0.5);
                doc.setDrawColor(209, 213, 219);
                doc.line(col1, yPos, pageWidth - 20, yPos);
                yPos += 8;

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(31, 41, 55);
                doc.text('TOTAL AMOUNT DUE:', col1, yPos);
                doc.setFontSize(20);
                doc.setTextColor(139, 111, 71); // Oak-600
                doc.text(`$${parseFloat(feeInput.value).toFixed(2)}`, pageWidth - 20, yPos, { align: 'right' });
                yPos += 12;
            }

            // Notes
            if (notesInput.value) {
                doc.setLineWidth(0.5);
                doc.setDrawColor(229, 231, 235);
                doc.line(col1, yPos, pageWidth - 20, yPos);
                yPos += 8;

                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'bold');
                doc.text('NOTES:', col1, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setTextColor(55, 65, 81);
                const noteLines = doc.splitTextToSize(notesInput.value, pageWidth - 40);
                doc.text(noteLines, col1, yPos);
            }

            // Save PDF using a blob to prevent navigation issues in PWA
            const fileNameBase = clientNameInput.value || 'invoice';
            const dateStr = new Date().toISOString().slice(0, 10);
            const fileName = `invoice_${fileNameBase.replace(/\s+/g, '_')}_${dateStr}.pdf`;
            
            const pdfBlob = doc.output('blob');
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Update invoice number tracking for current business profile
            if (currentProfile) {
                currentProfile.lastInvoiceNumber = usedNumber;
                persistProfiles();
            }

            // Update placeholder for next invoice
            invoiceNumberInput.placeholder = formatInvoiceNumber(usedNumber + 1);
            invoiceNumberInput.value = '';

            // Show success message
            successMessage.classList.remove('hidden');
            successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 5000);

            updatePreview();
        }

        // Fill demo data
        function fillDemoData() {
            const today = new Date().toISOString().slice(0, 10);
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

            clientNameInput.value = 'Pied Piper Solutions';
            clientAddressInput.value = '123 Innovation Blvd\nTech Park, CA 94103';

            invoiceDateInput.value = today;
            workStartDateInput.value = today;
            workEndDateInput.value = nextWeek;

            servicesInput.value = 'Magical Code Transmutation Services\n- Converting coffee into functional software\n- Reality distortion field maintenance\n- Quantum bug hunting and extermination';

            feeInput.value = '1234.56';
            notesInput.value = 'Note: Any existential crises caused by our reality-bending services are included at no extra cost.';

            updatePreview();
            invoicePreview.classList.remove('hidden');
            invoicePreview.scrollIntoView({ behavior: 'smooth' });
        }

        // --- Event Listeners and Initialization ---

        // Get the add/remove buttons
        const addBusinessProfileBtn = document.getElementById('addBusinessProfileBtn');
        const deleteBusinessProfileBtn = document.getElementById('deleteBusinessProfileBtn');

        window.addEventListener('DOMContentLoaded', () => {
            loadProfiles();
            updateUiForProfileSwitch();

            // Set default invoice date
            if (!invoiceDateInput.value) {
                invoiceDateInput.value = new Date().toISOString().slice(0, 10);
            }

            // Initialize import button in unselected state
            importModeButton.classList.remove('import-button-selected');
            
            checkAutoCollapse();

            // Re-add listeners for main actions
            const formInputs = [
                businessNameInput, yourNameInput, phoneNumberInput, businessAddressInput,
                invoiceNumberInput, clientNameInput, clientAddressInput,
                invoiceDateInput, workStartDateInput, workEndDateInput, servicesInput, feeInput, notesInput
            ];

            formInputs.forEach(input => {
                input.addEventListener('input', updatePreview);
            });

            previewBtn.addEventListener('click', () => {
                updatePreview();
                invoicePreview.classList.remove('hidden');
                invoicePreview.scrollIntoView({ behavior: 'smooth' });
            });

            generateBtn.addEventListener('click', generatePDF);
            fillDemoBtn.addEventListener('click', function() {
                if (confirm('Instafill will add witty sample data to all fields. Any existing data will be overwritten. Continue?')) {
                    fillDemoData();
                }
            });
        });

        // Add event listeners for the profile buttons
        addBusinessProfileBtn.addEventListener('click', addNewBusinessProfile);
        deleteBusinessProfileBtn.addEventListener('click', removeBusinessProfile);

        // Auto-save business details on blur
        const profileInputs = [businessNameInput, yourNameInput, phoneNumberInput, businessAddressInput];
        profileInputs.forEach(input => {
            input.addEventListener('blur', saveCurrentProfileData);
        });

        // Update business profile tab label when business name changes
        businessNameInput.addEventListener('input', function() {
            const tabButton = document.querySelector(`button[data-profile-index="${currentProfileIndex}"]`);
            if (tabButton) {
                tabButton.textContent = this.value || `Business ${currentProfileIndex + 1}`;
            }
        });
    </script>
</body>
</html>
